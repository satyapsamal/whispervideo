<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Whisper | Private Messaging</title>
    <!-- Favicon Integration -->
    <link rel="icon" type="image/webp" href="favicon.webp">
    <!-- Montserrat Font -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- PeerJS Library for P2P connection -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --text-primary: #ffffff;
            --accent-blue: #007aff; /* iOS Blue */
            --bubble-bg: #1a1a1a;
            --modal-bg: #0a0a0a;
            --toggle-bg: #39393d;
            --record-red: #ff3b30;
            --call-green: #34c759;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Login Screen */
        #login-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 100;
            background: var(--bg-color);
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        h1 { font-size: 2.5rem; margin-bottom: 2.5rem; letter-spacing: 4px; font-weight: 300; }
        
        .toggle-group {
            background: #111;
            padding: 4px;
            border-radius: 12px;
            display: flex;
            margin-bottom: 2rem;
            border: 1px solid #222;
        }

        .toggle-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: #666;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: var(--toggle-bg);
            color: white;
        }

        .input-group { margin-bottom: 1.5rem; text-align: left; }
        .input-group label { display: block; font-size: 0.75rem; margin-bottom: 0.5rem; color: #888; font-weight: 600; }
        
        input[type="text"] {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            padding: 14px;
            border-radius: 12px;
            color: white;
            font-family: inherit;
            outline: none;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus { border-color: var(--accent-blue); }

        .btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-secondary { background: #111; color: white; border: 1px solid #333; }

        /* Chat Interface */
        #chat-interface {
            display: none;
            flex-direction: column;
            height: 100vh;
        }

        header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            border-bottom: 0.5px solid #222;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-left { display: flex; align-items: center; gap: 10px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; }
        .status-online { background: var(--call-green); }

        .header-actions { display: flex; gap: 18px; align-items: center; }
        .icon-btn { background: none; border: none; cursor: pointer; color: white; display: flex; align-items: center; padding: 4px; }

        #messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .msg { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4; position: relative; }
        .msg.sent { align-self: flex-end; background: var(--accent-blue); color: white; border-bottom-right-radius: 4px; }
        .msg.received { align-self: flex-start; background: var(--bubble-bg); color: white; border-bottom-left-radius: 4px; }
        
        .media-msg img, .media-msg video { max-width: 100%; border-radius: 12px; margin-top: 5px; }

        .typing-indicator { font-size: 0.75rem; color: #666; font-style: italic; margin-left: 5px; height: 15px; }

        /* Input Area */
        .input-bar {
            padding: 10px 20px 35px;
            background: #000;
            display: flex;
            align-items: center;
            gap: 12px;
            border-top: 0.5px solid #222;
        }

        .input-wrapper {
            flex: 1;
            background: #1c1c1e;
            border-radius: 20px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
        }

        .input-wrapper input {
            flex: 1;
            background: none;
            border: none;
            color: white;
            outline: none;
            padding: 5px;
            font-family: inherit;
        }

        /* Video Call Overlay */
        #video-call-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: none;
            flex-direction: column;
            z-index: 2000;
        }
        
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { 
            position: absolute; 
            top: 40px; right: 20px; 
            width: 110px; height: 160px; 
            border-radius: 16px; 
            border: 1px solid rgba(255,255,255,0.3);
            object-fit: cover;
            z-index: 2001;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .call-controls {
            position: absolute;
            bottom: 60px;
            left: 0; right: 0;
            display: flex;
            justify-content: center;
            gap: 30px;
            z-index: 2002;
        }

        .end-call-btn {
            background: var(--record-red);
            width: 70px; height: 70px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255,59,48,0.3);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--modal-bg);
            border: 1px solid #222;
            padding: 35px;
            border-radius: 24px;
            text-align: center;
            width: 100%;
            max-width: 340px;
        }

        #my-code-display { font-family: monospace; background: #111; padding: 15px; border-radius: 12px; margin: 20px 0; word-break: break-all; border: 1px dashed #444; color: var(--accent-blue); font-size: 1.1rem; }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-card">
            <h1>WHISPER</h1>
            
            <div class="toggle-group">
                <button class="toggle-btn active" id="btn-host-toggle" onclick="switchLoginMode('host')">HOST</button>
                <button class="toggle-btn" id="btn-join-toggle" onclick="switchLoginMode('join')">JOIN</button>
            </div>

            <div id="host-view">
                <p style="color: #666; font-size: 0.85rem; margin-bottom: 2rem;">Create a private encrypted channel and share the key.</p>
                <button class="btn btn-primary" onclick="initHost()">GENERATE CHANNEL</button>
            </div>

            <div id="join-view" style="display: none;">
                <div class="input-group">
                    <label>ACCESS KEY</label>
                    <input type="text" id="join-id" placeholder="Enter partner's key...">
                </div>
                <button class="btn btn-primary" onclick="initJoin()">CONNECT TO CHANNEL</button>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div id="chat-interface">
        <header>
            <div class="header-left">
                <div id="status-dot" class="status-dot"></div>
                <span id="header-title" style="font-weight: 600; font-size: 0.9rem; letter-spacing: 0.5px;">ESTABLISHING...</span>
            </div>
            <div class="header-actions">
                <!-- Video Call Icon (Facetime Vector) -->
                <button class="icon-btn" onclick="startVideoCall()" id="video-call-btn">
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 10L19.5528 7.72361C20.2177 7.39116 21 7.87465 21 8.61803V15.382C21 16.1253 20.2177 16.6088 19.5528 16.2764L15 14M5 18H13C14.1046 18 15 17.1046 15 16V8C15 6.89543 14.1046 6 13 6H5C3.89543 6 3 6.89543 3 8V16C3 17.1046 3.89543 18 5 18Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <!-- Phone Call Icon -->
                <button class="icon-btn">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
                </button>
                <!-- Logout/Exit Icon -->
                <button class="icon-btn" onclick="toggleConfirm(true)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>
                </button>
            </div>
        </header>

        <div id="messages-container"></div>
        <div id="typing-status" class="typing-indicator"></div>

        <div class="input-bar">
            <button class="icon-btn" onclick="fileInput.click()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
            </button>
            <input type="file" id="file-input" style="display:none" accept="image/*,video/*">
            <div class="input-wrapper">
                <input type="text" id="message-input" placeholder="Message...">
            </div>
        </div>
    </div>

    <!-- Video Call Overlay -->
    <div id="video-call-overlay">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="call-controls">
            <div class="end-call-btn" onclick="endVideoCall()">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="white"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
            </div>
        </div>
    </div>

    <!-- Modal for Channel ID -->
    <div id="code-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>SECURE KEY</h3>
            <p style="font-size: 0.8rem; color: #888; margin-top: 10px;">Your partner needs this key to enter the channel.</p>
            <div id="my-code-display">
                <span id="my-code">...</span>
            </div>
            <button class="btn btn-primary" onclick="copyCode()">COPY TO CLIPBOARD</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <p style="font-weight: 600;">Close this secure session?</p>
            <p style="color: #666; font-size: 0.8rem; margin-top: 5px;">All messages will be wiped instantly.</p>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button class="btn btn-secondary" style="margin:0" onclick="toggleConfirm(false)">KEEP</button>
                <button class="btn btn-primary" style="margin:0; background: var(--record-red);" onclick="exitChatroom()">EXIT</button>
            </div>
        </div>
    </div>

    <script>
        let peer, conn, currentCall;
        let myId = '';
        let localStream = null;

        const loginScreen = document.getElementById('login-screen');
        const chatInterface = document.getElementById('chat-interface');
        const codeModal = document.getElementById('code-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const messagesContainer = document.getElementById('messages-container');
        const msgInput = document.getElementById('message-input');
        const fileInput = document.getElementById('file-input');
        const typingStatus = document.getElementById('typing-status');
        const statusDot = document.getElementById('status-dot');
        const headerTitle = document.getElementById('header-title');
        const videoOverlay = document.getElementById('video-call-overlay');

        function switchLoginMode(mode) {
            const hostView = document.getElementById('host-view');
            const joinView = document.getElementById('join-view');
            const btnHost = document.getElementById('btn-host-toggle');
            const btnJoin = document.getElementById('btn-join-toggle');

            if (mode === 'host') {
                hostView.style.display = 'block';
                joinView.style.display = 'none';
                btnHost.classList.add('active');
                btnJoin.classList.remove('active');
            } else {
                hostView.style.display = 'none';
                joinView.style.display = 'block';
                btnHost.classList.remove('active');
                btnJoin.classList.add('active');
            }
        }

        function initPeer() {
            peer = new Peer();
            peer.on('open', (id) => {
                myId = id;
                document.getElementById('my-code').textContent = id;
            });

            peer.on('connection', (c) => {
                conn = c;
                setupChat();
            });

            peer.on('call', async (call) => {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localStream = stream;
                document.getElementById('local-video').srcObject = stream;
                
                call.answer(stream);
                currentCall = call;
                videoOverlay.style.display = 'flex';
                
                call.on('stream', (remoteStream) => {
                    document.getElementById('remote-video').srcObject = remoteStream;
                });
                
                call.on('close', endVideoCall);
            });
        }

        async function startVideoCall() {
            if (!conn || !conn.open) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localStream = stream;
                document.getElementById('local-video').srcObject = stream;
                
                const call = peer.call(conn.peer, stream);
                currentCall = call;
                videoOverlay.style.display = 'flex';
                
                call.on('stream', (remoteStream) => {
                    document.getElementById('remote-video').srcObject = remoteStream;
                });
                
                call.on('close', endVideoCall);
            } catch (err) {
                console.error("Failed to get media", err);
            }
        }

        function endVideoCall() {
            if (currentCall) currentCall.close();
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            videoOverlay.style.display = 'none';
            document.getElementById('local-video').srcObject = null;
            document.getElementById('remote-video').srcObject = null;
        }

        function initHost() {
            initPeer();
            codeModal.style.display = 'flex';
        }

        function initJoin() {
            const id = document.getElementById('join-id').value.trim();
            if (!id) return;
            initPeer();
            peer.on('open', () => {
                conn = peer.connect(id);
                setupChat();
            });
        }

        function setupChat() {
            loginScreen.style.display = 'none';
            codeModal.style.display = 'none';
            chatInterface.style.display = 'flex';
            
            conn.on('open', () => {
                statusDot.classList.add('status-online');
                headerTitle.textContent = 'SECURE CHANNEL';
            });

            conn.on('data', (data) => {
                if (data === 'WHISPER_TYPING_ON') {
                    typingStatus.textContent = 'Partner is typing...';
                } else if (data === 'WHISPER_TYPING_OFF') {
                    typingStatus.textContent = '';
                } else if (typeof data === 'string' && data.startsWith('WHISPER_IMG_')) {
                    appendMediaMessage(data.replace('WHISPER_IMG_', ''), 'image', 'received');
                } else if (typeof data === 'string' && data.startsWith('WHISPER_VID_')) {
                    appendMediaMessage(data.replace('WHISPER_VID_', ''), 'video', 'received');
                } else {
                    appendMessage(data, 'received');
                }
            });

            conn.on('close', () => {
                statusDot.classList.remove('status-online');
                headerTitle.textContent = 'OFFLINE';
                setTimeout(() => location.reload(), 2000);
            });
        }

        function appendMessage(text, side) {
            const div = document.createElement('div');
            div.className = `msg ${side}`;
            div.textContent = text;
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function appendMediaMessage(src, type, side) {
            const div = document.createElement('div');
            div.className = `msg ${side} media-msg`;
            if (type === 'image') {
                const img = document.createElement('img');
                img.src = src;
                div.appendChild(img);
            } else {
                const vid = document.createElement('video');
                vid.src = src;
                vid.controls = true;
                div.appendChild(vid);
            }
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        let typingTimeout;
        msgInput.addEventListener('input', () => {
            if (!conn?.open) return;
            conn.send('WHISPER_TYPING_ON');
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                conn.send('WHISPER_TYPING_OFF');
            }, 2000);
        });

        msgInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && msgInput.value.trim() !== '' && conn?.open) {
                const val = msgInput.value.trim();
                conn.send('WHISPER_TYPING_OFF');
                conn.send(val);
                appendMessage(val, 'sent');
                msgInput.value = '';
                clearTimeout(typingTimeout);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || !conn?.open) return;
            const reader = new FileReader();
            const type = file.type.startsWith('video/') ? 'video' : 'image';
            reader.onload = (ev) => {
                conn.send((type === 'video' ? 'WHISPER_VID_' : 'WHISPER_IMG_') + ev.target.result);
                appendMediaMessage(ev.target.result, type, 'sent');
            };
            reader.readAsDataURL(file);
        });

        function toggleConfirm(show) { confirmModal.style.display = show ? 'flex' : 'none'; }
        function exitChatroom() { location.reload(); }
        function copyCode() {
            const code = document.getElementById('my-code').textContent;
            navigator.clipboard.writeText(code);
            const original = document.getElementById('my-code').textContent;
            document.getElementById('my-code').textContent = "COPIED!";
            setTimeout(() => document.getElementById('my-code').textContent = original, 2000);
        }
    </script>
</body>
</html>